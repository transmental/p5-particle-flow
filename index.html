<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Mouse-Follow Sketch</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: black;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
    <script>
      let particles = [];
      let colors = [];
      const numParticles = 2000;
      const resolution = 80;
      const renderWidth = 3000;
      const renderHeight = 3000;
      let cols, rows;
      let flowField;

      const MAX_BRIGHTNESS = 100;
      const MAX_ALPHA = 5;

      function setup() {
        createCanvas(windowWidth, windowHeight, P2D);
        pixelDensity(1);

        const params = new URLSearchParams(window.location.search);
        const seed = params.get("seed") || "default-seed";
        const numericSeed = hashSeed(seed);
        randomSeed(numericSeed);
        noiseSeed(numericSeed);

        const primaryHue = numericSeed % 255;
        colors = [
          primaryHue,
          (primaryHue + 120) % 255,
          (primaryHue + 240) % 255,
        ];

        colorMode(HSB, 255);
        blendMode(ADD);

        cols = floor(renderWidth / resolution);
        rows = floor(renderHeight / resolution);
        flowField = new Float32Array(cols * rows * 2);

        for (let i = 0; i < numParticles; i++) {
          particles.push(new Particle());
        }
      }

      function draw() {
        let z = frameCount * 0.01;
        let idx = 0;
        for (let x = 0; x < cols; x++) {
          for (let y = 0; y < rows; y++) {
            const angle = noise(x * 0.1, y * 0.1, z) * TWO_PI * 4;
            flowField[idx] = cos(angle) * 0.5;
            flowField[idx + 1] = sin(angle) * 0.5;
            idx += 2;
          }
        }

        background(0, 10);

        // compute transforms
        const scaleFactor = max(width / renderWidth, height / renderHeight);
        const offsetX = (width - renderWidth * scaleFactor) / 2;
        const offsetY = (height - renderHeight * scaleFactor) / 2;
        const followMode = frameCount > 500;
        let mxRender = 0,
          myRender = 0;
        if (followMode) {
          mxRender = (mouseX - offsetX) / scaleFactor;
          myRender = (mouseY - offsetY) / scaleFactor;
        }

        push();
        translate(offsetX, offsetY);
        scale(scaleFactor);
        for (let p of particles) {
          p.follow(flowField, followMode, mxRender, myRender);
          p.update();
          p.edges();
          p.show();
        }
        pop();
      }

      class Particle {
        constructor() {
          this.pos = createVector(random(renderWidth), random(renderHeight));
          this.vel = createVector();
          this.acc = createVector();
          this.maxSpeed = 4;
          this.h = colors[floor(random(colors.length))];
        }
        follow(field, followMode, mx, my) {
          if (followMode) {
            // vector toward mouse
            const target = createVector(mx, my);
            const desired = p5.Vector.sub(target, this.pos).setMag(0.5);
            this.acc.add(desired);
          } else {
            // normal flowField
            const x = floor(this.pos.x / resolution);
            const y = floor(this.pos.y / resolution);
            const i = 2 * (x + y * cols);
            this.acc.x += field[i];
            this.acc.y += field[i + 1];
          }
        }
        update() {
          this.vel.add(this.acc).limit(this.maxSpeed);
          this.pos.add(this.vel);
          this.acc.mult(0);
        }
        edges() {
          if (this.pos.x > renderWidth) this.pos.x = 0;
          if (this.pos.x < 0) this.pos.x = renderWidth;
          if (this.pos.y > renderHeight) this.pos.y = 0;
          if (this.pos.y < 0) this.pos.y = renderHeight;
        }
        show() {
          noStroke();
          fill(this.h, MAX_BRIGHTNESS, MAX_BRIGHTNESS, MAX_ALPHA);
          ellipse(this.pos.x, this.pos.y, 4);
        }
      }

      function hashSeed(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          hash = (hash << 5) - hash + str.charCodeAt(i);
          hash = hash & hash;
        }
        return abs(hash);
      }

      function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
      }
    </script>
  </head>
  <body></body>
</html>
